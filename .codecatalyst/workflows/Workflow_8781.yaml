Name: SimpleChat_Test_Workflow
SchemaVersion: "1.0"

# Automatic triggers for test workflow
Triggers:
  - Type: Push
    Branches:
      - master
      - main
      - develop
  - Type: PullRequest
    Events:
      - Open
      - Revision

# Define action configurations
Actions:
  Install_Dependencies:
    Identifier: aws/github-actions-runner@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Name: Install frontend dependencies
          Run: |
            cd /projects/simple_chat_application
            npm install
        - Name: Install backend dependencies
          Run: |
            cd /projects/simple_chat_application/backend
            npm install

  Frontend_Tests:
    Identifier: aws/managed-test@v1.0.0
    DependsOn:
      - Install_Dependencies
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: frontend
    Configuration:
      Steps:
        - Name: Run frontend tests
          Run: |
            cd /projects/simple_chat_application
            CI=true npm test -- --coverage --testResultsProcessor="jest-junit"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Compute:
      Type: EC2
      Fleet: Linux.x86-64.Large
    Environment:
      Name: test-cicd-env

  Backend_Tests:
    Identifier: aws/managed-test@v1.0.0
    DependsOn:
      - Install_Dependencies
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: backend
    Configuration:
      Steps:
        - Name: Run backend unit tests
          Run: |
            cd /projects/simple_chat_application/backend
            npm test -- --coverage --testResultsProcessor="jest-junit"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Compute:
      Type: EC2
      Fleet: Linux.x86-64.Large
    Environment:
      Name: test-cicd-env

  Integration_Tests:
    Identifier: aws/managed-test@v1.0.0
    DependsOn:
      - Install_Dependencies
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: integration
    Configuration:
      Steps:
        - Name: Install jest-junit reporter
          Run: |
            cd /projects/simple_chat_application
            npm install --save-dev jest-junit
        - Name: Run API integration tests
          Run: |
            cd /projects/simple_chat_application
            npm run test:api -- --testResultsProcessor="jest-junit"
        - Name: Run Socket integration tests
          Run: |
            cd /projects/simple_chat_application
            npm run test:socket -- --testResultsProcessor="jest-junit"
        - Name: Run Security tests
          Run: |
            cd /projects/simple_chat_application
            npm run test:security -- --testResultsProcessor="jest-junit"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Compute:
      Type: EC2
      Fleet: Linux.x86-64.Large
    Environment:
      Name: test-cicd-env

  E2E_Tests:
    Identifier: aws/managed-test@v1.0.0
    DependsOn:
      - Install_Dependencies
    Inputs:
      Sources:
        - WorkflowSource
    Outputs:
      AutoDiscoverReports:
        Enabled: true
        ReportNamePrefix: e2e
    Configuration:
      Steps:
        - Name: Install jest-junit reporter
          Run: |
            cd /projects/simple_chat_application
            npm install --save-dev jest-junit
        - Name: Run E2E tests
          Run: |
            cd /projects/simple_chat_application
            npm run test:e2e -- --testResultsProcessor="jest-junit"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Compute:
      Type: EC2
      Fleet: Linux.x86-64.Large
    Environment:
      Name: test-cicd-env